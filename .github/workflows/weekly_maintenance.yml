name: Weekly host maintenance

on:
  schedule:
    - cron: "0 5 * * 2" # At 05:00, only on Tuesday
  workflow_dispatch:
    inputs:
      batch_size:
        description: "Number of hosts to patch in parallel"
        required: true
        type: string
        default: '2'

jobs:
  deploy:
    name: Weekly host maintenance
    runs-on: ubuntu-latest
    concurrency:
      group: host_management

    steps:
      - name: Check out repository
        uses: actions/checkout@v6

      - name: Install Ansible
        run: |
          python -m pip install --upgrade pip
          pip install ansible
          pip install bitwarden-sdk
          ansible-galaxy collection install -r ./ansible/requirements.yml
          ansible-galaxy role install -r ./ansible/requirements.yml

      - name: ‚¨áÔ∏è Get Secrets from Bitwarden
        uses: bitwarden/sm-action@v2
        with:
          access_token: ${{ secrets.BWS_ACCESS_TOKEN }}
          secrets: |
            38c9a270-f749-436d-bdff-b39000d8fd77 > ANSIBLE_SSH_KEY
            ae8d79f6-fb4a-434c-94f2-b3860149c5ec > VPS_HOST
            683478bf-6fb8-4985-905f-b39d01641765 > VPS_HOST_SSH_PUBLIC_KEYS

      # Load the SSH private key into the ssh-agent
      - name: üîë Load SSH Key
        uses: webfactory/ssh-agent@v0.9.1
        with:
          log-public-key: false
          ssh-private-key: ${{ env.ANSIBLE_SSH_KEY }}

      - name: Add the VPS host public keys to known_hosts
        run: |
          touch ~/.ssh/known_hosts
          chmod 600 ~/.ssh/known_hosts
          echo $VPS_HOST_SSH_PUBLIC_KEYS | sed "s/localhost/$VPS_HOST/g" >> ~/.ssh/known_hosts 

      - name: Disable strict host key checking for VPN hosts
        run: |
          cat << EOF >> ~/.ssh/config
          Host 10.13.*
            StrictHostKeyChecking no
            UserKnownHostsFile /dev/null
          EOF

      - name: üê≥ Prune unused docker images
        env:
          BWS_ACCESS_TOKEN: ${{ secrets.BWS_ACCESS_TOKEN }}
          ANSIBLE_CONFIG: ansible/ansible.cfg
        run: |
          ansible-playbook -i ansible/inventory.yml \
           -e "batch_size=${{ github.event.inputs.batch_size || '2' }}" \
           ansible/playbooks/docker-prune.yml

      - name: üî® Patch all hosts
        env:
          BWS_ACCESS_TOKEN: ${{ secrets.BWS_ACCESS_TOKEN }}
          ANSIBLE_CONFIG: ansible/ansible.cfg
        run: |
          ansible-playbook -i ansible/inventory.yml \
           -l 'all:!home-server-wireguard-router-wg1' \
           -e "batch_size=${{ github.event.inputs.batch_size || '2' }}" \
           ansible/playbooks/patch.yml
