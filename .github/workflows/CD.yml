name: Ansible Deployment

on:
  push:
    branches:
      - main
  workflow_dispatch: {}

jobs:
  deploy:
    name: Deploy Ansible Playbook
    runs-on: ubuntu-latest
    concurrency:
      group: host_management

    steps:
      - name: Check out repository
        uses: actions/checkout@v5

      - name: Install Ansible and dependencies
        run: |
          python -m pip install --upgrade pip
          pip install ansible
          pip install bitwarden-sdk
          ansible-galaxy collection install bitwarden.secrets
          ansible-galaxy role install -r ./ansible/requirements.yml

      - name: Prepare control node
        env:
          ANSIBLE_CONFIG: ansible/ansible.cfg
        run: |
          ansible-playbook ansible/playbooks/prepare_control_node.yml

      - name: â¬‡ï¸ Get Secrets from Bitwarden
        uses: bitwarden/sm-action@v2
        with:
          access_token: ${{ secrets.BWS_ACCESS_TOKEN }}
          secrets: |
            38c9a270-f749-436d-bdff-b39000d8fd77 > ANSIBLE_SSH_KEY

      # Load the SSH private key into the ssh-agent
      - name: ðŸ”‘ Load SSH Key
        uses: webfactory/ssh-agent@v0.9.1
        with:
          log-public-key: false
          ssh-private-key: ${{ env.ANSIBLE_SSH_KEY }}

      # Run the Ansible playbook
      - name: ðŸ…° Run Ansible Playbook
        env:
          BWS_ACCESS_TOKEN: ${{ secrets.BWS_ACCESS_TOKEN }}
          ANSIBLE_CONFIG: ansible/ansible.cfg
        run: |
          ansible-playbook \
           -i "gateway," \
           -e "local_repo_path=$GITHUB_WORKSPACE" \
           ansible/playbooks/deploy_docker.yml
