name: Continuous Deployment

on:
  push:
    branches:
      - main
    paths:
      - 'hosts/**'
  workflow_dispatch:
    inputs:
      target_host:
        description: "Target host"
        required: true
        type: choice
        options:
          - vps
          - home-server-containers

jobs:
  deploy:
    name: Deploy Ansible Playbook
    runs-on: ubuntu-latest
    concurrency:
      group: host_management

    steps:
      - name: Check out repository
        uses: actions/checkout@v6

      - name: Fetch history for git diff
        run: git fetch --depth=2

      - name: Detect modified folders
        id: detect-changes
        run: |
          if [ "$(git rev-parse --is-shallow-repository)" = "true" ]; then
            git fetch --unshallow
          fi
          folders=$(git diff --name-only HEAD~1 HEAD | grep '^hosts/' | cut -d/ -f2 | sort | uniq)
          echo "Modified folders: $folders"
          echo "folders=$folders" >> $GITHUB_OUTPUT

      - name: Install Ansible and dependencies
        run: |
          python -m pip install --upgrade pip
          pip install ansible
          pip install bitwarden-sdk
          ansible-galaxy collection install -r ./ansible/requirements.yml
          ansible-galaxy role install -r ./ansible/requirements.yml

      - name: â¬‡ï¸ Get Secrets from Bitwarden
        uses: bitwarden/sm-action@v2
        with:
          access_token: ${{ secrets.BWS_ACCESS_TOKEN }}
          secrets: |
            38c9a270-f749-436d-bdff-b39000d8fd77 > ANSIBLE_SSH_KEY
            ae8d79f6-fb4a-434c-94f2-b3860149c5ec > VPS_HOST

      # Load the SSH private key into the ssh-agent
      - name: ðŸ”‘ Load SSH Key
        uses: webfactory/ssh-agent@v0.9.1
        with:
          log-public-key: false
          ssh-private-key: ${{ env.ANSIBLE_SSH_KEY }}

      - name: Clear ANSIBLE_SSH_KEY env variable
        run: echo "ANSIBLE_SSH_KEY=" >> $GITHUB_ENV

      - name: Disable strict host key checking
        run: |
          cat << EOF >> ~/.ssh/config
          Host $VPS_HOST
            StrictHostKeyChecking no
            UserKnownHostsFile /dev/null
          EOF

      - name: ðŸ…° Deploy docker on hosts(s)
        if: github.event_name != 'workflow_dispatch'
        env:
          BWS_ACCESS_TOKEN: ${{ secrets.BWS_ACCESS_TOKEN }}
          ANSIBLE_CONFIG: ansible/ansible.cfg
        shell: bash
        run: |
          IFS=' ' read -r -a folder_array <<< "${{ steps.detect-changes.outputs.folders }}"

          for folder in "${folder_array[@]}"; do
            ansible-playbook -i ansible/inventory.yml \
             -e "local_repo_path=$GITHUB_WORKSPACE" \
             ansible/playbooks/deploy-${folder}.yml
          done

      - name: ðŸ…° Deploy docker on specified host
        if: github.event_name == 'workflow_dispatch'
        env:
          BWS_ACCESS_TOKEN: ${{ secrets.BWS_ACCESS_TOKEN }}
          ANSIBLE_CONFIG: ansible/ansible.cfg
        shell: bash
        run: |
          ansible-playbook -i ansible/inventory.yml \
            -e "local_repo_path=$GITHUB_WORKSPACE" \
            ansible/playbooks/deploy-${{ github.event.inputs.target_host }}.yml