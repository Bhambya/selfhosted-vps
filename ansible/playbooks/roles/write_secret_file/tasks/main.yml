- name: Lookup secret on the control node
  ansible.builtin.shell: "set -o pipefail && bws secret get {{ item['secret'] }} | jq -r '.value'"
  args:
    executable: /bin/bash
  register: write_secret_file_bw_secret_output
  changed_when: false
  failed_when: write_secret_file_bw_secret_output.rc != 0
  delegate_to: localhost

- name: Make sure destination dir exists
  become: true
  ansible.builtin.file:
    path: "{{ item.path | dirname }}"
    state: directory
    mode: "700"

- name: Write secret file to target host
  become: true
  ansible.builtin.copy:
    dest: "{{ item.path }}"
    content: |
      {% if (item.base64 | default(False)) %}
      {{ write_secret_file_bw_secret_output.stdout | b64decode }}
      {% else %}
      {{ write_secret_file_bw_secret_output.stdout }}
      {% endif %}
    mode: "{{ item.mode | default('600') }}"
